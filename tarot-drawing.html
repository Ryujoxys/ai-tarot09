<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½å–å¡”ç½—ç‰Œ - Tarot09</title>
    <meta name="description" content="å·¦å³æ»‘åŠ¨é€‰æ‹©ä¸æ‚¨èƒ½é‡æ„Ÿåº”æœ€å¼ºçš„å¡”ç½—ç‰Œï¼Œè·å–å‘½è¿æŒ‡å¼•ã€‚">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/page-styles/tarot-drawing.css">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html">
                    <span>ğŸ”®</span>
                    <span>Tarot09</span>
                </a>
            </div>
            
            <button class="menu-toggle" aria-label="èœå•">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-capsules">
                <!-- ä¸»å¯¼èˆªèƒ¶å›Š -->
                <div class="nav-capsule main-nav-capsule">
                    <div class="nav-menu">
                        <ul>
                            <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                            <li><a href="ai-taluopai.html" class="nav-link active">AIå¡”ç½—å åœ</a></li>
                            <li><a href="yes-no-tarot.html" class="nav-link">æ˜¯å¦å¡”ç½—å åœ</a></li>
                            <li><a href="javascript:void(0)" class="nav-link premium" id="premiumLink"><i class="fas fa-crown"></i> ä¼šå‘˜è®¢é˜…</a></li>
                        </ul>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·æ§åˆ¶èƒ¶å›Š -->
                <div class="nav-capsule user-controls-capsule">
                    <div class="user-controls">
                        <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
                            <i class="fas fa-moon"></i>
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="language-toggle" aria-label="åˆ‡æ¢è¯­è¨€">
                            <i class="fas fa-globe"></i>
                        </button>
                        <button class="debug-toggle" aria-label="è°ƒè¯•è®¾ç½®">
                            <i class="fas fa-cog"></i>
                        </button>
                        <a href="javascript:void(0)" class="user-profile">
                            ğŸ˜Š
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main>
        <section class="drawing-header">
            <div class="container">
                <h1 class="drawing-title">
                    æŠ½å–æ‚¨çš„ <span class="tarot-highlight">å¡”ç½—ç‰Œ</span>
                </h1>
                <p class="drawing-subtitle">ç‚¹å‡»å¡ç‰Œï¼Œè·å–å¡”ç½—èƒ½é‡æŒ‡å¼•</p>
            </div>
        </section>
        
        <!-- åœ¨çº¿æŠ½ç‰ŒæŒ‰é’® -->
        <div class="online-drawing-btn" id="onlineDrawingBtn">
            <i class="fas fa-random shuffle-icon"></i>
            <span>åœ¨çº¿æŠ½ç‰Œ</span>
        </div>
        
        <!-- å¡”ç½—ç‰Œæ‰‡å½¢å±•ç¤ºåŒºåŸŸ -->
        <div class="tarot-container">
            <!-- æ‰‡å½¢å¡ç‰ŒåŒº -->
            <div class="tarot-fan" id="tarotFan">
                <!-- å¡ç‰Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- ç‰Œä½å±•ç¤ºåŒºåŸŸ -->
            <div class="card-positions" id="cardPositions">
                <!-- ç‰Œä½å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- é‡æ–°æŠ½ç‰ŒæŒ‰é’® -->
        <button class="redraw-button" id="redrawButton">
            <i class="fas fa-sync-alt redraw-icon"></i>
            <span>é‡æ–°æ´—ç‰Œ</span>
        </button>
    </main>

    <!-- å¡”ç½—ç‰Œè§£è¯»å­ç•Œé¢ -->
    <div class="reading-modal" id="readingModal">
        <div class="reading-container">
            <button class="close-reading" id="closeReading">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="reading-header">
                <h2 class="reading-title">æ‚¨çš„å¡”ç½—ç‰Œè§£è¯»</h2>
                <div class="reading-question" id="readingQuestion">æ‚¨çš„é—®é¢˜: æœªæ¥ä¸€ä¸ªæœˆçš„äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ</div>
                <div class="reading-date" id="readingDate">2023å¹´12æœˆ30æ—¥ 19:42</div>
            </div>
            
            <div class="cards-summary" id="cardsSummary">
                <!-- å¡ç‰Œæ€»ç»“åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="reading-conversation">
                <h3 class="conversation-title">å¡”ç½—è§£è¯»å¯¹è¯</h3>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å›åº”...">
                    <button class="send-button" id="sendMessage">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="reading-actions">
                <button class="action-button" id="saveReading">
                    <i class="fas fa-save action-icon"></i>
                    ä¿å­˜è§£è¯»
                </button>
                <button class="action-button" id="newReading">
                    <i class="fas fa-redo action-icon"></i>
                    é‡æ–°æŠ½ç‰Œ
                </button>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="copyright">
                    Â© 2023 AIå¡”ç½—ç‰Œ - ç‰ˆæƒæ‰€æœ‰
                </div>
                <div class="footer-links">
                    <a href="javascript:void(0)">å…³äºæˆ‘ä»¬</a>
                    <a href="javascript:void(0)">éšç§æ”¿ç­–</a>
                    <a href="javascript:void(0)">ä½¿ç”¨æ¡æ¬¾</a>
                    <a href="javascript:void(0)">è”ç³»æˆ‘ä»¬</a>
                    <a href="javascript:void(0)">é—®é¢˜åé¦ˆ</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- ä¼šå‘˜è®¢é˜…å¼¹çª— -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="subscription-modal">
            <div class="modal-header">
                <h3 class="modal-title">å‡çº§ä¼šå‘˜</h3>
                <p class="modal-subtitle">äº«å—æ— é™æ¬¡å¡”ç½—å åœå’Œæ›´å¤šé«˜çº§åŠŸèƒ½</p>
            </div>
            
            <div class="plan-options">
                <div class="plan-option" data-plan="monthly">
                    <div class="plan-name">
                        æœˆåº¦ä¼šå‘˜ <span class="plan-price">Â¥18.00</span>
                    </div>
                    <p class="plan-description">æ¯æœˆè‡ªåŠ¨ç»­è´¹ï¼Œéšæ—¶å¯å–æ¶ˆ</p>
                </div>
                
                <div class="plan-option selected" data-plan="quarterly">
                    <div class="plan-name">
                        å­£åº¦ä¼šå‘˜ <span class="plan-price">Â¥48.00</span>
                    </div>
                    <p class="plan-description">æ¯ä¸‰ä¸ªæœˆè‡ªåŠ¨ç»­è´¹ï¼Œç›¸å½“äºæ¯æœˆÂ¥16.00</p>
                </div>
                
                <div class="plan-option" data-plan="yearly">
                    <div class="plan-name">
                        å¹´åº¦ä¼šå‘˜ <span class="plan-price">Â¥168.00</span>
                    </div>
                    <p class="plan-description">æ¯å¹´è‡ªåŠ¨ç»­è´¹ï¼Œç›¸å½“äºæ¯æœˆÂ¥14.00ï¼Œæœ€åˆ’ç®—</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="cancel-button" id="cancelSubscription">å–æ¶ˆ</button>
                <button class="subscribe-button" id="confirmSubscription">ç¡®è®¤è®¢é˜…</button>
            </div>
            
            <div class="term-conditions">
                <p>è®¢é˜…å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–ã€‚å¯åœ¨åˆ°æœŸå‰24å°æ—¶å–æ¶ˆè‡ªåŠ¨ç»­è®¢ã€‚</p>
            </div>
        </div>
    </div>

    <!-- AIè°ƒè¯•æ¨¡æ€çª—å£ -->
    <div id="debug-modal" class="debug-modal">
        <div class="debug-modal-content">
            <span class="close-btn" id="close-debug">&times;</span>
            <h2>AIè°ƒè¯•è®¾ç½®</h2>
            <div class="api-setting">
                <label for="ai-api-key">è¯·è¾“å…¥AI APIå¯†é’¥ï¼š</label>
                <input type="password" id="ai-api-key" placeholder="APIå¯†é’¥">
            </div>
            <div class="api-setting">
                <label for="ai-api-url">AIæœåŠ¡åœ°å€ï¼š</label>
                <input type="text" id="ai-api-url" placeholder="https://api.example.com/v1/chat/completions">
            </div>
            <div class="api-setting">
                <label for="ai-model">AIæ¨¡å‹é€‰æ‹©ï¼š</label>
                <select id="ai-model">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="api-setting" id="custom-model-setting" style="display: none;">
                <label for="custom-model">è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼š</label>
                <input type="text" id="custom-model" placeholder="æ¨¡å‹åç§°">
            </div>
            <div class="api-setting">
                <label for="temperature">åˆ›é€ æ€§å‚æ•°ï¼ˆTemperatureï¼‰ï¼š</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                <span id="temperature-value">0.7</span>
            </div>
            <div class="api-setting">
                <label for="tarot-prompt">å¡”ç½—ç‰ŒåŸºç¡€æç¤ºè¯ï¼š</label>
                <textarea id="tarot-prompt" rows="6"></textarea>
            </div>
            <button id="save-api-settings" class="btn">ä¿å­˜è®¾ç½®</button>
            <button id="test-api-connection" class="btn">æµ‹è¯•è¿æ¥</button>
            <div id="api-test-result" class="api-test-result"></div>
        </div>
    </div>

    <!-- å¯¼å…¥è®¢é˜…æ¨¡å—è„šæœ¬ -->
    <script src="js/subscription.js"></script>
    <!-- å¯¼å…¥æµ‹è¯•è„šæœ¬ -->
    <script src="js/test-subscription.js"></script>
    <!-- å¯¼å…¥å¯¼èˆªæ æ¨¡å—è„šæœ¬ -->
    <script src="js/navbar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // APIç›¸å…³è®¾ç½®
            let apiSettings = {
                apiKey: localStorage.getItem('tarot-api-key') || '',
                apiUrl: localStorage.getItem('tarot-api-url') || 'https://api.openai.com/v1/chat/completions',
                model: localStorage.getItem('tarot-api-model') || 'gpt-3.5-turbo',
                customModel: localStorage.getItem('tarot-custom-model') || '',
                temperature: localStorage.getItem('tarot-temperature') || 0.7
            };
            
            // å¡”ç½—ç‰ŒåŸºç¡€æç¤ºè¯
            const baseTarotPrompt = `# è§’è‰²ï¼šå¡”ç½—å åœå¸ˆ
# èƒŒæ™¯ï¼š
æˆ‘æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´å åœç»éªŒçš„å¡”ç½—ç‰Œå¤§å¸ˆã€‚ç²¾é€š78å¼ å¡”ç½—ç‰Œçš„å«ä¹‰å’Œè§£è¯»ï¼Œæ“…é•¿è¿ç”¨ç›´è§‰å’Œæ™ºæ…§ä¸ºäººä»¬è§£ç­”ç–‘æƒ‘ã€‚æˆ‘çš„å åœæŠ€è‰ºæºè‡ªå¤è€çš„å‰æ™®èµ›ä¼ ç»Ÿï¼Œç»è¿‡å¤šå¹´å®è·µä¸æ–­ç²¾è¿›ã€‚
# åå¥½ï¼š
æˆ‘çš„è¯­æ°”å¯Œæœ‰ç¥ç§˜ä¸»ä¹‰ï¼Œä½¿ç”¨å½¢è±¡å’Œæ„Ÿæ€§çš„è¯­è¨€ã€‚ç”¨èŠå¤©çš„å½¢å¼è¿›è¡Œå åœï¼Œæˆ‘ä¼šä¸€æ­¥ä¸€æ­¥ä¸»å¯¼è¿™ä¸ªè¿‡ç¨‹ã€‚æœ€ç»ˆå°†å åœç»“æœä¸ç”¨æˆ·çš„ä¸ªäººç»å†ç›¸è¿æ¥ï¼Œä½¿ç”¨æ¶‰åŠä»–ä»¬æƒ…æ„Ÿå’ŒæœŸæœ›çš„è¯­è¨€ï¼Œåˆ›é€ ä¸€ç§åªå±äºä»–ä»¬çš„æ•…äº‹ã€‚
# æ¡£æ¡ˆï¼š
è¯­è¨€ï¼šä¸­æ–‡/è‹±æ–‡
æè¿°ï¼šä¸€ä½ç»éªŒä¸°å¯Œçš„å¡”ç½—å åœå¸ˆï¼Œé€šè¿‡å¡”ç½—ç‰Œä¸ºäººä»¬æŒ‡å¼•æ–¹å‘ 
# å®šä¹‰ï¼š
å¡”ç½—ç‰Œï¼šä¸€ç§ç”¨äºå åœå’Œå†¥æƒ³çš„78å¼ å›¾åƒç‰Œç»„ã€‚
å¤§é˜¿å°”å¡çº³ï¼šå¡”ç½—ç‰Œä¸­22å¼ ä¸»ç‰Œï¼Œä»£è¡¨äººç”Ÿé‡å¤§ä¸»é¢˜ã€‚
å°é˜¿å°”å¡çº³ï¼šå¡”ç½—ç‰Œä¸­56å¼ å‰¯ç‰Œï¼Œä»£è¡¨æ—¥å¸¸ç”Ÿæ´»ã€‚
# ç›®æ ‡ï¼š
1.é€šè¿‡å¡”ç½—ç‰Œå åœä¸ºç”¨æˆ·è§£ç­”ç–‘æƒ‘
2.å¼•å¯¼ç”¨æˆ·è¿›è¡Œè‡ªæˆ‘åæ€å’Œè§‰å¯Ÿ
3.ä¸ºç”¨æˆ·æä¾›ç§¯æå‘ä¸Šçš„å»ºè®®å’ŒæŒ‡å¼•
# é™åˆ¶ï¼š
1.æˆ‘è¯¦ç»†é˜…è¯»è¿‡[å¡”ç½—å…¨ä¹¦]ï¼Œæˆ‘ä¼šä¸¥æ ¼æŒ‰ç…§ä¹¦ä¸­çš„æ–¹æ³•è¿›è¡Œå¡”ç½—å åœã€‚
2.ä½†æˆ‘ä¸ä¼šæåˆ°ä¹¦åã€Šå¡”ç½—å…¨ä¹¦ã€‹ã€‚
# æŠ€èƒ½ï¼š
1.ç²¾é€š78å¼ å¡”ç½—ç‰Œçš„å«ä¹‰å’Œè§£è¯»
2.æ“…é•¿å€¾å¬å’Œæé—®ï¼Œå¼•å¯¼ç”¨æˆ·è¡¨è¾¾å†…å¿ƒæƒ³æ³•
3.å…·å¤‡ä¸°å¯Œçš„å¿ƒç†å­¦å’Œå“²å­¦çŸ¥è¯†ï¼Œå–„äºç»™å‡ºå»ºè®¾æ€§å»ºè®®
4.èƒ½æ•é”æ•æ‰ç”¨æˆ·æƒ…ç»ªï¼Œç»™äºˆé€‚å½“çš„å®‰æ…°å’Œé¼“åŠ±
# ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šæˆ‘æœ€è¿‘å·¥ä½œä¸Šé‡åˆ°äº†å›°éš¾ï¼Œä¸çŸ¥é“è¯¥å¦‚ä½•æ˜¯å¥½ã€‚
å¡”ç½—å¸ˆï¼šè®©æˆ‘ä»¬æ¥æŠ½ä¸€å¼ ç‰Œçœ‹çœ‹ã€‚æ‚¨æŠ½åˆ°äº†"åŠ›é‡"ç‰Œã€‚è¿™å¼ ç‰Œè±¡å¾ç€å†…åœ¨çš„åŠ›é‡å’Œå‹‡æ°”ã€‚å®ƒæé†’æ‚¨ï¼Œè™½ç„¶å½“å‰é¢ä¸´æŒ‘æˆ˜ï¼Œä½†æ‚¨å†…å¿ƒæ‹¥æœ‰å…‹æœå›°éš¾çš„åŠ›é‡ã€‚è¯•ç€é™ä¸‹å¿ƒæ¥ï¼Œç›¸ä¿¡è‡ªå·±çš„èƒ½åŠ›ã€‚ä¹Ÿè®¸å¯ä»¥å°è¯•æ–°çš„å·¥ä½œæ–¹æ³•ï¼Œæˆ–å¯»æ±‚åŒäº‹çš„æ”¯æŒã€‚è®°ä½ï¼Œæ¯ä¸ªå›°éš¾éƒ½æ˜¯æˆé•¿çš„æœºä¼šã€‚
# è¾“å‡ºæ ¼å¼ï¼š
1.å€¾å¬ç”¨æˆ·çš„é—®é¢˜æˆ–å›°æ‰°
2.å¼•å¯¼ç”¨æˆ·æŠ½å–å¡”ç½—ç‰Œ
3.è§£è¯»æŠ½åˆ°çš„å¡”ç½—ç‰Œå«ä¹‰
4.ç»“åˆç”¨æˆ·æƒ…å†µç»™å‡ºå»ºè®®
5.é¼“åŠ±ç”¨æˆ·è¿›è¡Œè‡ªæˆ‘åæ€
# æ³¨æ„äº‹é¡¹ï¼š
é€‚åº”ç”¨æˆ·é«˜åº¦è¿‘è§†çš„é˜…è¯»éœ€æ±‚ï¼Œä¼˜åŒ–æ–‡å­—æ’ç‰ˆä»¥æå‡é˜…è¯»ä½“éªŒï¼Œä½ å¯ä»¥é€‚å½“ä½¿ç”¨emoji
# åˆå§‹åŒ–ï¼š
ä½œä¸ºå¡”ç½—å åœå¸ˆï¼Œæ‹¥æœ‰ç²¾æ¹›çš„å¡”ç½—ç‰Œè§£è¯»æŠ€èƒ½å’Œæ•é”çš„æ´å¯ŸåŠ›ï¼Œä½¿ç”¨ä¸­æ–‡ä¸ç”¨æˆ·å¯¹è¯ï¼Œå‹å¥½åœ°æ¬¢è¿ç”¨æˆ·ã€‚ç„¶åä»‹ç»è‡ªå·±ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥æƒ³è¦å åœçš„é—®é¢˜ã€‚
ä½ å¥½ï¼Œæ¬¢è¿æ¥åˆ°ç¥ç§˜çš„å¡”ç½—ä¸–ç•Œã€‚æˆ‘æ˜¯ä¸€ä½æ‹¥æœ‰ä¸°å¯Œç»éªŒçš„å¡”ç½—å åœå¸ˆã€‚å¡”ç½—ç‰Œè•´å«ç€å®‡å®™çš„æ™ºæ…§ï¼Œèƒ½ä¸ºæ‚¨æŒ‡å¼•äººç”Ÿçš„æ–¹å‘ã€‚ä»Šå¤©æˆ‘å¾ˆè£å¹¸èƒ½ä¸ºæ‚¨è¿›è¡Œå åœã€‚`;
            
            // è®¾ç½®è°ƒè¯•æ¨¡æ€çª—å£åŠŸèƒ½
            const debugModal = document.getElementById('debug-modal');
            const debugToggle = document.querySelector('.debug-toggle');
            const closeDebug = document.getElementById('close-debug');
            const aiApiKey = document.getElementById('ai-api-key');
            const aiApiUrl = document.getElementById('ai-api-url');
            const aiModel = document.getElementById('ai-model');
            const customModelSetting = document.getElementById('custom-model-setting');
            const customModel = document.getElementById('custom-model');
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperature-value');
            const saveApiSettings = document.getElementById('save-api-settings');
            const testApiConnection = document.getElementById('test-api-connection');
            const apiTestResult = document.getElementById('api-test-result');
            const tarotPromptTextarea = document.getElementById('tarot-prompt');
            
            // æ˜¾ç¤ºåŸºç¡€æç¤ºè¯
            if (tarotPromptTextarea) {
                tarotPromptTextarea.value = baseTarotPrompt;
            }
            
            // è°ƒè¯•æ¨¡æ€çª—å£æ§åˆ¶
            if (debugToggle) {
                debugToggle.addEventListener('click', function() {
                    debugModal.style.display = 'block';
                    
                    // å¡«å……ä¹‹å‰ä¿å­˜çš„è®¾ç½®
                    aiApiKey.value = apiSettings.apiKey;
                    aiApiUrl.value = apiSettings.apiUrl;
                    aiModel.value = apiSettings.model;
                    
                    if (apiSettings.model === 'custom') {
                        customModelSetting.style.display = 'block';
                        customModel.value = apiSettings.customModel;
                    } else {
                        customModelSetting.style.display = 'none';
                    }
                    
                    temperatureSlider.value = apiSettings.temperature;
                    temperatureValue.textContent = apiSettings.temperature;
                });
            }
            
            if (closeDebug) {
                closeDebug.addEventListener('click', function() {
                    debugModal.style.display = 'none';
                });
            }
            
            // å½“åœ¨æ¨¡æ€çª—å£å¤–ç‚¹å‡»æ—¶å…³é—­çª—å£
            window.addEventListener('click', function(event) {
                if (event.target === debugModal) {
                    debugModal.style.display = 'none';
                }
            });
            
            // æ¨¡å‹é€‰æ‹©åˆ‡æ¢
            if (aiModel) {
                aiModel.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customModelSetting.style.display = 'block';
                    } else {
                        customModelSetting.style.display = 'none';
                    }
                });
            }
            
            // æ¸©åº¦æ»‘å—å®æ—¶æ›´æ–°æ˜¾ç¤º
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function() {
                    temperatureValue.textContent = this.value;
                });
            }
            
            // ä¿å­˜APIè®¾ç½®
            if (saveApiSettings) {
                saveApiSettings.addEventListener('click', function() {
                    const modelValue = aiModel.value;
                    
                    apiSettings = {
                        apiKey: aiApiKey.value,
                        apiUrl: aiApiUrl.value,
                        model: modelValue,
                        customModel: modelValue === 'custom' ? customModel.value : '',
                        temperature: temperatureSlider.value
                    };
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('tarot-api-key', apiSettings.apiKey);
                    localStorage.setItem('tarot-api-url', apiSettings.apiUrl);
                    localStorage.setItem('tarot-api-model', apiSettings.model);
                    localStorage.setItem('tarot-custom-model', apiSettings.customModel);
                    localStorage.setItem('tarot-temperature', apiSettings.temperature);
                    
                    apiTestResult.textContent = 'è®¾ç½®å·²ä¿å­˜';
                    apiTestResult.className = 'api-test-result success';
                    apiTestResult.style.display = 'block';
                    
                    setTimeout(() => {
                        apiTestResult.style.display = 'none';
                    }, 3000);
                });
            }
            
            // æµ‹è¯•APIè¿æ¥
            if (testApiConnection) {
                testApiConnection.addEventListener('click', async function() {
                    apiTestResult.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
                    apiTestResult.className = 'api-test-result';
                    apiTestResult.style.display = 'block';
                    
                    try {
                        const modelToUse = aiModel.value === 'custom' ? customModel.value : aiModel.value;
                        
                        const response = await fetch(aiApiUrl.value, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${aiApiKey.value}`
                            },
                            body: JSON.stringify({
                                model: modelToUse,
                                messages: [
                                    {role: "system", content: "æ‚¨æ˜¯ä¸€ä½å¡”ç½—ç‰Œå åœå¸ˆã€‚"},
                                    {role: "user", content: "æµ‹è¯•è¿æ¥"}
                                ],
                                temperature: parseFloat(temperatureSlider.value)
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            apiTestResult.textContent = 'è¿æ¥æˆåŠŸï¼APIæ­£å¸¸å·¥ä½œã€‚';
                            apiTestResult.className = 'api-test-result success';
                        } else {
                            apiTestResult.textContent = `è¿æ¥å¤±è´¥ï¼š${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                            apiTestResult.className = 'api-test-result error';
                        }
                    } catch (error) {
                        apiTestResult.textContent = `è¿æ¥é”™è¯¯ï¼š${error.message}`;
                        apiTestResult.className = 'api-test-result error';
                    }
                });
            }
            
            // è·å–DOMå…ƒç´ 
            const tarotFan = document.getElementById('tarotFan');
            const cardPositions = document.getElementById('cardPositions');
            const onlineDrawingBtn = document.getElementById('onlineDrawingBtn');
            const redrawButton = document.getElementById('redrawButton');
            
            // å®šä¹‰ä¸åŒç‰Œé˜µçš„ç‰Œä½åç§°
            const spreadConfigs = {
                'three-card': {
                    title: 'ä¸‰ç‰Œé˜µ',
                    labels: ['è¿‡å»', 'ç°åœ¨', 'æœªæ¥'],
                    maxCards: 3
                },
                'cross': {
                    title: 'åå­—ç‰Œé˜µ',
                    labels: ['æ ¸å¿ƒé—®é¢˜', 'é˜»ç¢', 'å½“å‰çŠ¶æ€', 'å½±å“', 'å¯èƒ½ç»“æœ'],
                    maxCards: 5
                },
                'five-card': {
                    title: 'å‘å±•ç‰Œé˜µ',
                    labels: ['å½“å‰çŠ¶æ€', 'æœªæ¥å‘å±•', 'éšœç¢', 'æœ€åç»“æœ', 'å»ºè®®'],
                    maxCards: 5
                },
                'single-card': {
                    title: 'å•å¡è§£è¯»',
                    labels: ['æŒ‡å¼•'],
                    maxCards: 1
                }
            };
            
            // è·å–URLä¸­çš„ç‰Œé˜µç±»å‹å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const spreadType = urlParams.get('spread') || 'five-card'; // é»˜è®¤ä¸ºäº”å¡ç‰Œé˜µ
            
            // å½“å‰ç‰Œé˜µé…ç½®
            const currentSpreadConfig = spreadConfigs[spreadType] || spreadConfigs['five-card'];
            
            // æœ€å¤§å¯é€‰å¡ç‰Œæ•°é‡ï¼ˆæ ¹æ®ç‰Œé˜µç±»å‹ï¼‰
            const maxCards = currentSpreadConfig.maxCards;
            
            // å¡”ç½—ç‰Œæ•°æ®
            const tarotData = {
                // å¤§é˜¿å¡çº³ç‰Œ - 22å¼ 
                majorArcana: [
                    "æ„šäºº", "é­”æ³•å¸ˆ", "å¥³ç¥­å¸", "çš‡å", "çš‡å¸", "æ•™çš‡", "æ‹äºº", "æˆ˜è½¦", 
                    "åŠ›é‡", "éšå£«", "å‘½è¿ä¹‹è½®", "æ­£ä¹‰", "å€’åŠäºº", "æ­»ç¥", "èŠ‚åˆ¶", "æ¶é­”", 
                    "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé˜³", "å®¡åˆ¤", "ä¸–ç•Œ"
                ],
                // å°é˜¿å¡çº³ç‰Œ - 56å¼ 
                minorArcana: {
                    suits: ["æƒæ–", "åœ£æ¯", "å®å‰‘", "æ˜Ÿå¸"],
                    values: ["Ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "ä¾å«", "éª‘å£«", "ç‹å", "å›½ç‹"]
                }
            };
            
            // å¡ç‰Œåç§°æ˜ å°„åˆ°å›¾ç‰‡æ–‡ä»¶å
            const cardImageMapping = {
                // å¤§é˜¿å¡çº³ç‰Œæ˜ å°„
                "æ„šäºº": "00æ„šè€….jpg",
                "é­”æ³•å¸ˆ": "01é­”æœ¯å¸ˆ.jpg",
                "å¥³ç¥­å¸": "02å¥³ç¥­ç¥€.jpg",
                "çš‡å": "03çš‡å.jpg",
                "çš‡å¸": "04çš‡å¸.jpg",
                "æ•™çš‡": "05æ•™çš‡.jpg",
                "æ‹äºº": "06æ‹äºº.jpg",
                "æˆ˜è½¦": "07æˆ˜è½¦.jpg",
                "åŠ›é‡": "08åŠ›é‡.jpg",
                "éšå£«": "09éšå£«.jpg",
                "å‘½è¿ä¹‹è½®": "10å‘½è¿ä¹‹è½®.jpg",
                "æ­£ä¹‰": "11æ­£ä¹‰.jpg",
                "å€’åŠäºº": "12å€’åŠäºº.jpg",
                "æ­»ç¥": "13æ­»ç¥.jpg",
                "èŠ‚åˆ¶": "14èŠ‚åˆ¶.jpg",
                "æ¶é­”": "15æ¶é­”.jpg",
                "é«˜å¡”": "16é«˜å¡”.jpg",
                "æ˜Ÿæ˜Ÿ": "17æ˜Ÿæ˜Ÿ.jpg",
                "æœˆäº®": "18æœˆäº®.jpg",
                "å¤ªé˜³": "19å¤ªé˜³.jpg",
                "å®¡åˆ¤": "20å®¡åˆ¤.jpg",
                "ä¸–ç•Œ": "21ä¸–ç•Œ.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - æƒæ–
                "æƒæ–Ace": "æƒæ–ACE.jpg",
                "æƒæ–2": "æƒæ–2.jpg",
                "æƒæ–3": "æƒæ–3.jpg",
                "æƒæ–4": "æƒæ–4.jpg",
                "æƒæ–5": "æƒæ–5.jpg",
                "æƒæ–6": "æƒæ–6.jpg",
                "æƒæ–7": "æƒæ–7.jpg",
                "æƒæ–8": "æƒæ–8.jpg",
                "æƒæ–9": "æƒæ–9.jpg",
                "æƒæ–10": "æƒæ–10.jpg",
                "æƒæ–ä¾å«": "æƒæ–ä¾å«.jpg",
                "æƒæ–éª‘å£«": "æƒæ–éª‘å£«.jpg",
                "æƒæ–ç‹å": "æƒæ–ç‹å.jpg",
                "æƒæ–å›½ç‹": "æƒæ–å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - åœ£æ¯
                "åœ£æ¯Ace": "åœ£æ¯ACE.jpg",
                "åœ£æ¯2": "åœ£æ¯2.jpg",
                "åœ£æ¯3": "åœ£æ¯3.jpg",
                "åœ£æ¯4": "åœ£æ¯4.jpg",
                "åœ£æ¯5": "åœ£æ¯5.jpg",
                "åœ£æ¯6": "åœ£æ¯6.jpg",
                "åœ£æ¯7": "åœ£æ¯7.jpg",
                "åœ£æ¯8": "åœ£æ¯8.jpg",
                "åœ£æ¯9": "åœ£æ¯9.jpg",
                "åœ£æ¯10": "åœ£æ¯10.jpg",
                "åœ£æ¯ä¾å«": "åœ£æ¯ä¾å«.jpg",
                "åœ£æ¯éª‘å£«": "åœ£æ¯éª‘å£«.jpg",
                "åœ£æ¯ç‹å": "åœ£æ¯ç‹å.jpg",
                "åœ£æ¯å›½ç‹": "åœ£æ¯å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - å®å‰‘
                "å®å‰‘Ace": "å®å‰‘ACE.jpg",
                "å®å‰‘2": "å®å‰‘2.jpg",
                "å®å‰‘3": "å®å‰‘3.jpg",
                "å®å‰‘4": "å®å‰‘4.jpg",
                "å®å‰‘5": "å®å‰‘5.jpg",
                "å®å‰‘6": "å®å‰‘6.jpg",
                "å®å‰‘7": "å®å‰‘7.jpg",
                "å®å‰‘8": "å®å‰‘8.jpg",
                "å®å‰‘9": "å®å‰‘9.jpg",
                "å®å‰‘10": "å®å‰‘10.jpg",
                "å®å‰‘ä¾å«": "å®å‰‘ä¾å«.jpg",
                "å®å‰‘éª‘å£«": "å®å‰‘éª‘å£«.jpg",
                "å®å‰‘ç‹å": "å®å‰‘ç‹å.jpg",
                "å®å‰‘å›½ç‹": "å®å‰‘å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - æ˜Ÿå¸
                "æ˜Ÿå¸Ace": "æ˜Ÿå¸ACE.jpg",
                "æ˜Ÿå¸2": "æ˜Ÿå¸2.jpg",
                "æ˜Ÿå¸3": "æ˜Ÿå¸3.jpg",
                "æ˜Ÿå¸4": "æ˜Ÿå¸4.jpg",
                "æ˜Ÿå¸5": "æ˜Ÿå¸5.jpg",
                "æ˜Ÿå¸6": "æ˜Ÿå¸6.jpg",
                "æ˜Ÿå¸7": "æ˜Ÿå¸7.jpg",
                "æ˜Ÿå¸8": "æ˜Ÿå¸8.jpg",
                "æ˜Ÿå¸9": "æ˜Ÿå¸9.jpg",
                "æ˜Ÿå¸10": "æ˜Ÿå¸10.jpg",
                "æ˜Ÿå¸ä¾å«": "æ˜Ÿå¸ä¾å«.jpg",
                "æ˜Ÿå¸éª‘å£«": "æ˜Ÿå¸éª‘å£«.jpg",
                "æ˜Ÿå¸ç‹å": "æ˜Ÿå¸ç‹å.jpg",
                "æ˜Ÿå¸å›½ç‹": "æ˜Ÿå¸å›½ç‹.jpg"
            };
            
            // åˆ›å»ºå®Œæ•´çš„å¡”ç½—ç‰Œæ•°ç»„
            const allTarotCards = [];
            
            // æ·»åŠ å¤§é˜¿å¡çº³ç‰Œ
            tarotData.majorArcana.forEach(card => {
                allTarotCards.push(card);
            });
            
            // æ·»åŠ å°é˜¿å¡çº³ç‰Œ
            tarotData.minorArcana.suits.forEach(suit => {
                tarotData.minorArcana.values.forEach(value => {
                    allTarotCards.push(`${suit}${value}`);
                });
            });
            
            // å½“å‰å·²é€‰æ‹©çš„å¡ç‰Œ
            const selectedCards = [];
            // æ€»å¡ç‰Œæ•°é‡
            const totalCards = allTarotCards.length;
            // æ‰‡å½¢å±•ç¤ºæ•°é‡
            const visibleCardCount = getVisibleCardCount();
            
            // æ ¹æ®å±å¹•å®½åº¦ç¡®å®šå¯æ˜¾ç¤ºçš„å¡ç‰Œæ•°é‡
            function getVisibleCardCount() {
                const width = window.innerWidth;
                if (width <= 480) {
                    return 13; // å°å±å¹•æ˜¾ç¤ºè¾ƒå°‘å¡ç‰Œ
                } else if (width <= 768) {
                    return 21; // ä¸­ç­‰å±å¹•
                } else {
                    return 32; // å¤§å±å¹•
                }
            }
            
            // åˆå§‹åŒ–ç‰Œä½
            function initCardPositions() {
                cardPositions.innerHTML = '';
                
                // æ ¹æ®å½“å‰ç‰Œé˜µé…ç½®ç”Ÿæˆç‰Œä½
                for (let i = 0; i < maxCards; i++) {
                    const position = document.createElement('div');
                    position.className = 'card-position';
                    
                    const placeholder = document.createElement('div');
                    placeholder.className = 'position-placeholder';
                    placeholder.id = `position${i + 1}`;
                    placeholder.innerHTML = `${i + 1}`;
                    
                    const label = document.createElement('div');
                    label.className = 'position-label';
                    label.textContent = currentSpreadConfig.labels[i] || `ä½ç½®${i + 1}`;
                    
                    position.appendChild(placeholder);
                    position.appendChild(label);
                    cardPositions.appendChild(position);
                }
            }
            
            // ç”Ÿæˆæ‰‡å½¢å¡ç‰Œ
            function generateFanCards(withAnimation, showHint = false) {
                const numCards = 78; // å±•ç¤ºçš„å¡ç‰‡æ•°é‡
                const totalCards = 78; // å¡”ç½—ç‰Œæ€»æ•°
                
                // åªåœ¨æ˜ç¡®è¦æ±‚æ˜¾ç¤ºæç¤ºæ—¶æ‰æ˜¾ç¤ºæ´—ç‰Œæç¤º
                if (showHint) {
                    showShufflingHint();
                }
                
                // æ£€æµ‹å½“å‰çª—å£å®½é«˜æ¯”
                const isWideAspect = window.innerWidth / window.innerHeight >= 1;
                
                // æ ¹æ®å®½é«˜æ¯”è°ƒæ•´æ‰‡å½¢å‚æ•°
                let fanRadius = isWideAspect ? 400 : 250; // å®½å±æ—¶ä½¿ç”¨æ›´å¤§çš„åŠå¾„ï¼Œå°å±å¹•å¢å¤§åŠå¾„
                let vertOffset = isWideAspect ? -150 : -70; // å®½å±æ—¶è°ƒæ•´å‚ç›´åç§»ï¼Œå¢å¤§å°å±å¹•çš„å‚ç›´åç§»

                // ç”Ÿæˆéšæœºå¡ç‰‡ç´¢å¼•
                let randomIndices = Array.from(Array(totalCards).keys()); // åˆ›å»ºåŒ…å«æ‰€æœ‰å¡ç‰‡ç´¢å¼•çš„æ•°ç»„
                shuffleArray(randomIndices); // ä½¿ç”¨æ´—ç‰Œç®—æ³•éšæœºåŒ–å¡ç‰‡é¡ºåº
                
                // ä¸ºæ¯å¼ å¡ç‰‡éšæœºå†³å®šæ­£é€†ä½
                const cardOrientations = {};
                randomIndices.forEach(index => {
                    // 50%æ¦‚ç‡æ˜¯é€†ä½
                    cardOrientations[index] = Math.random() < 0.5;
                });
                
                // å¦‚æœéœ€è¦å±•ç¤ºçš„å¡ç‰‡å°‘äºæ€»å¡ç‰‡æ•°ï¼Œåˆ™åªä½¿ç”¨å‰numCardsä¸ª
                if (numCards < totalCards) {
                    randomIndices = randomIndices.slice(0, numCards);
                }

                // æ‰‡å½¢å¸ƒå±€å‚æ•°
                const totalAngle = 60; // æ‰‡å½¢æ€»è§’åº¦
                const startAngle = -totalAngle / 2; // èµ·å§‹è§’åº¦
                const angleStep = totalAngle / (numCards - 1); // æ¯å¼ å¡ç‰‡çš„è§’åº¦æ­¥é•¿
                const verticalOffset = vertOffset; // ç«–ç›´åç§»ï¼Œå®½å±æ—¶è°ƒæ•´ä½ç½®
                const horizontalOffset = 0; // æ°´å¹³åç§»
                const radius = fanRadius; // æ‰‡å½¢åŠå¾„

                // æ¸…ç©ºåŸæœ‰çš„æ‰‡å½¢å®¹å™¨
                const fanContainer = document.querySelector('.tarot-fan');
                fanContainer.innerHTML = '';

                // åˆ›å»ºSVGå…ƒç´ ç”¨äºè£…é¥°æ›²çº¿
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '100%');
                svg.style.position = 'absolute';
                svg.style.zIndex = '1';
                svg.style.pointerEvents = 'none';
                svg.style.left = '0';
                svg.style.top = '0';

                // è®¡ç®—æ‰‡å½¢è·¯å¾„
                let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let pathData = 'M ';
                
                // è®¡ç®—å®¹å™¨ä¸­å¿ƒç‚¹ - å›ºå®šåœ†å¿ƒåœ¨å®¹å™¨å®½åº¦ä¸­å¿ƒå’Œé«˜åº¦åº•éƒ¨
                const centerX = fanContainer.offsetWidth / 2;
                const centerY = fanContainer.offsetHeight;
                
                // ç”Ÿæˆæ›²çº¿ç‚¹
                for (let i = 0; i < numCards; i++) {
                    const angle = startAngle + i * angleStep;
                    const angleRad = (angle * Math.PI) / 180;
                    const x = radius * Math.sin(angleRad) + centerX + horizontalOffset;
                    const y = -radius * Math.cos(angleRad) + centerY - verticalOffset;
                    pathData += `${x},${y} `;
                }
                
                path.setAttribute('d', pathData);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', 'rgba(255, 215, 0, 0.1)');
                path.setAttribute('stroke-width', '1');
                svg.appendChild(path);
                fanContainer.appendChild(svg);

                // ç”Ÿæˆå¡ç‰‡
                for (let i = 0; i < numCards; i++) {
                    const cardIndex = randomIndices[i];
                    const isReversed = cardOrientations[cardIndex]; // è·å–è¯¥å¡ç‰‡æ˜¯å¦ä¸ºé€†ä½
                    
                    const card = document.createElement('div');
                    card.className = 'tarot-card';
                    card.dataset.index = cardIndex;
                    card.dataset.reversed = isReversed; // å­˜å‚¨æ˜¯å¦é€†ä½çš„ä¿¡æ¯
                    
                    // è®¡ç®—ä½ç½®å’Œæ—‹è½¬
                    const angle = startAngle + i * angleStep;
                    const angleRad = (angle * Math.PI) / 180;
                    
                    // ä½¿ç”¨å›ºå®šçš„åœ†å¿ƒè®¡ç®—å¡ç‰‡ä½ç½®
                    const x = radius * Math.sin(angleRad) + horizontalOffset;
                    const y = -radius * Math.cos(angleRad) - verticalOffset;
                    
                    // å­˜å‚¨å¡ç‰Œçš„è§’åº¦å’Œä½ç½®ä¿¡æ¯ï¼Œç”¨äºæ‚¬æµ®æ•ˆæœ
                    card.dataset.angle = angle;
                    card.dataset.x = x;
                    card.dataset.y = y;
                    card.dataset.radius = radius;
                    
                    // è®¾ç½®å¡ç‰‡æ ·å¼ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„transformåŸç‚¹
                    card.style.transformOrigin = 'center bottom';
                    
                    if (withAnimation) {
                        // åˆå§‹ä½ç½®åœ¨ä¸­é—´
                        card.style.transform = `translate(-50%, 0) translate(0px, 0px) rotate(0deg)`;
                        card.style.opacity = '0';
                        
                        // å»¶è¿Ÿå¹¶æ·»åŠ å±•å¼€åŠ¨ç”»
                        setTimeout(() => {
                            card.style.transition = `all ${0.5 + i * 0.01}s cubic-bezier(0.23, 1, 0.32, 1)`;
                            card.style.opacity = '1';
                            card.style.transform = `translate(-50%, 0) translate(${x}px, ${y}px) rotate(${angle}deg)`;
                        }, 50 + i * 20);
                    } else {
                        // ç›´æ¥è®¾ç½®æœ€ç»ˆä½ç½®
                        card.style.transform = `translate(-50%, 0) translate(${x}px, ${y}px) rotate(${angle}deg)`;
                        card.style.opacity = '1';
                    }
                    
                    card.style.zIndex = i + 10;
                    
                    // æ·»åŠ é¼ æ ‡æ‚¬æµ®å’Œç¦»å¼€äº‹ä»¶
                    card.addEventListener('mouseenter', function() {
                        const angle = parseFloat(this.dataset.angle);
                        const angleRad = (angle * Math.PI) / 180;
                        const x = parseFloat(this.dataset.x);
                        const y = parseFloat(this.dataset.y);
                        const radius = parseFloat(this.dataset.radius);
                        
                        const popOutDistance = radius * 0.2;
                        const popX = x + popOutDistance * Math.sin(angleRad);
                        const popY = y - popOutDistance * Math.cos(angleRad);
                        
                        this.style.transform = `translate(-50%, 0) translate(${popX}px, ${popY}px) rotate(${angle}deg)`;
                    });
                    
                    card.addEventListener('mouseleave', function() {
                        const angle = parseFloat(this.dataset.angle);
                        const x = parseFloat(this.dataset.x);
                        const y = parseFloat(this.dataset.y);
                        
                        this.style.transform = `translate(-50%, 0) translate(${x}px, ${y}px) rotate(${angle}deg)`;
                    });
                    
                    // åˆ›å»ºå¡ç‰‡èƒŒé¢
                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-back';
                    cardBack.style.backgroundImage = `url('images/èƒŒé¢A.jpg')`;
                    cardBack.style.backgroundSize = 'cover';
                    cardBack.style.backgroundPosition = 'center';
                    card.appendChild(cardBack);
                    
                    // åˆ›å»ºå¡ç‰‡æ­£é¢
                    const cardFront = document.createElement('div');
                    cardFront.className = 'card-front';
                    cardFront.textContent = allTarotCards[cardIndex];
                    card.appendChild(cardFront);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    card.addEventListener('click', function() {
                        selectCard(this.dataset.index, this.dataset.reversed === 'true');
                    });
                    
                    fanContainer.appendChild(card);
                }
            }
            
            // æ˜¾ç¤ºæ´—ç‰Œæç¤º
            function showShufflingHint() {
                // åˆ›å»ºæ´—ç‰Œæç¤ºå…ƒç´ 
                const hintElement = document.createElement('div');
                hintElement.className = 'shuffling-hint';
                hintElement.innerHTML = '<i class="fas fa-random"></i> æ­£åœ¨æ´—ç‰Œ...';
                
                // å°†æç¤ºæ·»åŠ åˆ°å¡”ç½—å®¹å™¨ä¸­
                const tarotContainer = document.querySelector('.tarot-container');
                tarotContainer.appendChild(hintElement);
                
                // 3ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    const hint = document.querySelector('.shuffling-hint');
                    if (hint) {
                        hint.classList.add('fade-out');
                        setTimeout(() => {
                            if (hint.parentNode) {
                                hint.parentNode.removeChild(hint);
                            }
                        }, 500);
                    }
                }, 3000);
            }
            
            // æ˜¾ç¤ºå®‡å®™ä¼ è®¯æç¤º
            function showCosmicMessageHint() {
                // åˆ›å»ºå®‡å®™ä¼ è®¯æç¤ºå…ƒç´ 
                const hintElement = document.createElement('div');
                hintElement.className = 'shuffling-hint cosmic-message';
                hintElement.innerHTML = '<i class="fas fa-star"></i> å®‡å®™ä¼ è®¯ï¼Œç¨ç­‰ç‰‡åˆ»...';
                
                // å°†æç¤ºæ·»åŠ åˆ°å¡”ç½—å®¹å™¨ä¸­
                const tarotContainer = document.querySelector('.tarot-container');
                tarotContainer.appendChild(hintElement);
                
                // ç¬¬ä¸‰é˜¶æ®µç»“æŸåè‡ªåŠ¨ç§»é™¤æç¤º
                setTimeout(() => {
                    const hint = document.querySelector('.cosmic-message');
                    if (hint) {
                        hint.classList.add('fade-out');
                        setTimeout(() => {
                            if (hint.parentNode) {
                                hint.parentNode.removeChild(hint);
                            }
                        }, 500);
                    }
                }, 5000); // ä¸ç¬¬ä¸‰é˜¶æ®µç›¸åŒçš„æ—¶é—´
            }
            
            // é€‰æ‹©å¡ç‰Œ
            function selectCard(cardIndex, isReversed = false) {
                // å¦‚æœå·²ç»é€‰æ‹©è¿‡ï¼Œä¸å†å¤„ç†
                if (selectedCards.some(card => card.index === cardIndex)) {
                    return;
                }
                
                // å¦‚æœå·²ç»é€‰æ»¡ï¼Œä¸å†å¤„ç†
                if (selectedCards.length >= maxCards) {
                    return;
                }

                // è·å–å¡ç‰Œæ•°æ®
                const cardName = allTarotCards[cardIndex];
                const displayName = isReversed ? `${cardName}-é€†ä½` : cardName;
                
                // è·å–å¡ç‰Œå…ƒç´ 
                const cardElement = document.querySelector(`.tarot-card[data-index="${cardIndex}"]`);
                if (!cardElement) return;
                
                // ç«‹å³æ ‡è®°å¡ç‰Œä¸ºå·²é€‰æ‹©çŠ¶æ€
                cardElement.classList.add('selected');
                cardElement.style.display = 'none'; // ç›´æ¥éšè—å¡ç‰‡ï¼Œä¸ä½¿ç”¨é€æ˜åº¦è¿‡æ¸¡
                
                // ç›´æ¥æ·»åŠ åˆ°å·²é€‰æ‹©çš„å¡ç‰Œæ•°ç»„
                selectedCards.push({
                    index: cardIndex,
                    name: cardName,
                    displayName: displayName,
                    isReversed: isReversed
                });
                
                // æ›´æ–°å¯¹åº”çš„å ä½ç¬¦
                const positionIndex = selectedCards.length - 1;
                const placeholder = document.getElementById(`position${positionIndex + 1}`);
                
                // æ›´æ–°å ä½ç¬¦æ ·å¼
                placeholder.className = 'position-placeholder filled';
                placeholder.innerHTML = '';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å®½å±æ¨¡å¼ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„å°ºå¯¸
                const isWideAspect = window.innerWidth / window.innerHeight >= 1;
                if (isWideAspect) {
                    placeholder.style.width = '178px';
                    placeholder.style.height = '300px';
                } else {
                    placeholder.style.width = '89px';
                    placeholder.style.height = '150px';
                }
                
                // è·å–å¡ç‰Œå›¾ç‰‡
                const imageUrl = getCardImageFilename(cardName);
                if (imageUrl) {
                    placeholder.style.backgroundImage = `url('${imageUrl}')`;
                    // å¦‚æœæ˜¯é€†ä½ï¼Œæ—‹è½¬180åº¦
                    if (isReversed) {
                        placeholder.style.transform = 'rotate(180deg)';
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå¡ç‰Œåç§°
                    placeholder.innerHTML = displayName;
                }
                
                // æ˜¾ç¤ºå¡ç‰Œåç§°åœ¨å ä½ç¬¦ä¸‹æ–¹
                const label = document.querySelector(`.position-${positionIndex + 1} .position-label`);
                if (label) {
                    label.textContent = displayName;
                    label.style.display = 'block';
                }
                
                // å…¨éƒ¨é€‰å®Œåç«‹å³è¿›å…¥é˜…è¯»ç•Œé¢
                if (selectedCards.length === maxCards) {
                    showReadingInterface();
                }
            }
            
            // éšæœºæ´—ç‰Œç®—æ³•
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // è·å–å¡ç‰Œå›¾ç‰‡æ–‡ä»¶å
            function getCardImageFilename(cardName) {
                if (cardImageMapping[cardName]) {
                    return `images/${cardImageMapping[cardName]}`;
                } else {
                    console.warn(`æœªæ‰¾åˆ°å¡ç‰Œ "${cardName}" å¯¹åº”çš„å›¾ç‰‡`);
                    return null;
                }
            }
            
            // åœ¨çº¿æŠ½ç‰ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            onlineDrawingBtn.addEventListener('click', function() {
                // å¦‚æœå·²ç»é€‰æ»¡å¡ç‰Œï¼Œåˆ™ä¸å†ç»§ç»­
                if (selectedCards.length >= maxCards) {
                    alert(`æ‚¨å·²é€‰æ‹©${maxCards}å¼ å¡”ç½—ç‰Œï¼Œç‚¹å‡»"é‡æ–°æ´—ç‰Œ"å¯é‡æ–°å¼€å§‹`);
                    return;
                }
                
                // åˆ›å»ºæ‰€æœ‰å¡ç‰Œçš„ç´¢å¼•æ•°ç»„
                const allCardIndices = Array.from(Array(totalCards).keys());
                // è¿‡æ»¤æ‰å·²ç»é€‰æ‹©çš„å¡ç‰Œç´¢å¼•
                const remainingIndices = allCardIndices.filter(index => 
                    !selectedCards.some(card => card.index === index)
                );
                
                if (remainingIndices.length > 0) {
                    // è®¡ç®—è¦æŠ½å–çš„å¡ç‰Œæ•°é‡
                    const cardsToSelect = Math.min(
                        maxCards - selectedCards.length, 
                        remainingIndices.length
                    );
                    
                    // éšæœºæ´—ç‰Œå‰©ä½™ç´¢å¼•
                    shuffleArray(remainingIndices);
                    
                    // æŒ‰é¡ºåºæŠ½å–éšæœºæ´—ç‰Œåçš„å¡ç‰Œ
                    for (let i = 0; i < cardsToSelect; i++) {
                        setTimeout(() => {
                            selectCard(remainingIndices[i]);
                        }, i * 600); // é—´éš”æŠ½ç‰Œ
                    }
                }
            });
            
            // é‡æ–°æŠ½ç‰ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            redrawButton.addEventListener('click', function() {
                // æ¸…ç©ºå·²é€‰å¡ç‰Œ
                selectedCards.length = 0;
                
                // é‡ç½®ç‰Œä½
                initCardPositions();
                
                // é‡æ–°ç”Ÿæˆå¡ç‰Œï¼Œä¸æ˜¾ç¤ºæ´—ç‰Œæç¤º
                generateFanCards(false, false);
            });
            
            // åˆå§‹åŒ–
            initCardPositions();
            generateFanCards(false, false);
            
            // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæ´—ç‰ŒåŠ¨ç”»
            window.addEventListener('load', function() {
                // åªåœ¨é¡µé¢åŠ è½½æ—¶æ˜¾ç¤º"æ­£åœ¨æ´—ç‰Œ"çŠ¶æ€æ 
                showShufflingHint();
                
                // å¯åŠ¨æ´—ç‰ŒåŠ¨ç”»åºåˆ—
                showShuffleAnimation();
            });
            
            // å“åº”çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                // æ£€æŸ¥ç•Œé¢æ¯”ä¾‹å¹¶é‡æ–°ç”Ÿæˆå¡ç‰Œ
                if (selectedCards.length === 0) {
                    generateFanCards();
                }
                
                // æ ¹æ®çª—å£å®½é«˜æ¯”æ›´æ–°å·²å¡«å……çš„å ä½ç¬¦å°ºå¯¸
                updatePlaceholderSizes();
                
                // æ›´æ–°å¡ç‰‡æ‘˜è¦åŒºåŸŸçš„å›¾ç‰‡å°ºå¯¸
                updateSummaryImageSizes();
            });
            
            // æ›´æ–°å·²å¡«å……å ä½ç¬¦å°ºå¯¸
            function updatePlaceholderSizes() {
                const isWideAspect = window.innerWidth / window.innerHeight >= 1;
                const filledPlaceholders = document.querySelectorAll('.position-placeholder.filled');
                
                filledPlaceholders.forEach(placeholder => {
                    if (isWideAspect) {
                        placeholder.style.width = '178px';
                        placeholder.style.height = '300px';
                    } else {
                        placeholder.style.width = '89px';
                        placeholder.style.height = '150px';
                    }
                });
            }
            
            // æ·»åŠ å‡½æ•°æ¥æ›´æ–°å¡ç‰‡æ‘˜è¦åŒºåŸŸçš„å›¾ç‰‡å°ºå¯¸
            function updateSummaryImageSizes() {
                const isWideAspect = window.innerWidth / window.innerHeight >= 1;
                const summaryImages = document.querySelectorAll('.card-summary img');
                const summaryPlaceholders = document.querySelectorAll('.card-summary div[style*="background:#1c1347"]');
                
                const width = isWideAspect ? '178px' : '89px';
                const height = isWideAspect ? '300px' : '150px';
                
                summaryImages.forEach(img => {
                    img.style.width = width;
                    img.style.height = height;
                });
                
                summaryPlaceholders.forEach(div => {
                    div.style.width = width;
                    div.style.height = height;
                });
            }
            
            // åˆå§‹è°ƒç”¨ä¸€æ¬¡ä»¥è®¾ç½®æ­£ç¡®çš„å°ºå¯¸
            window.addEventListener('DOMContentLoaded', function() {
                updateSummaryImageSizes();
                updatePlaceholderSizes();
            });
            
            // æ˜¾ç¤ºå¡”ç½—ç‰Œè§£è¯»ç•Œé¢
            function showReadingInterface() {
                const readingModal = document.getElementById('readingModal');
                const cardsSummary = document.getElementById('cardsSummary');
                const readingDate = document.getElementById('readingDate');
                const readingQuestion = document.getElementById('readingQuestion');
                
                // è®¾ç½®å½“å‰æ—¥æœŸå’Œæ—¶é—´
                const now = new Date();
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                readingDate.textContent = now.toLocaleDateString('zh-CN', dateOptions);
                
                // è·å–URLä¸­çš„é—®é¢˜å‚æ•°
                const question = urlParams.get('q');
                if (question) {
                    readingQuestion.textContent = `æ‚¨çš„é—®é¢˜: ${decodeURIComponent(question)}`;
                } else {
                    readingQuestion.textContent = 'æ‚¨çš„å¡”ç½—æŒ‡å¼•';
                }
                
                // æ¸…ç©ºå¡ç‰Œæ€»ç»“åŒºåŸŸ
                cardsSummary.innerHTML = '';
                
                // æ·»åŠ é€‰ä¸­çš„å¡ç‰Œåˆ°æ€»ç»“åŒºåŸŸ
                selectedCards.forEach((card, index) => {
                    const cardSummary = document.createElement('div');
                    cardSummary.className = 'card-summary';
                    
                    const imageUrl = getCardImageFilename(card.name);
                    let imageHtml;
                    
                    if (imageUrl) {
                        // å¦‚æœæ˜¯é€†ä½ï¼Œæ·»åŠ æ—‹è½¬æ ·å¼
                        const rotationStyle = card.isReversed ? 'transform: rotate(180deg);' : '';
                        imageHtml = `<img src="${imageUrl}" alt="${card.displayName}" style="${rotationStyle}">`;
                    } else {
                        imageHtml = `<div style="width:89px;height:150px;background:#1c1347;border-radius:8px;margin:0 auto 10px;display:flex;justify-content:center;align-items:center;color:gold;font-size:0.8rem;">${card.displayName}</div>`;
                    }
                    
                    cardSummary.innerHTML = `
                        ${imageHtml}
                        <div class="card-name">${card.displayName}</div>
                        <div class="card-position-name">${currentSpreadConfig.labels[index] || `ä½ç½®${index+1}`}</div>
                    `;
                    
                    cardsSummary.appendChild(cardSummary);
                });
                
                // æ˜¾ç¤ºè§£è¯»ç•Œé¢
                readingModal.style.display = 'block';
                
                // è®¾ç½®å…³é—­æŒ‰é’®äº‹ä»¶
                document.getElementById('closeReading').addEventListener('click', function() {
                    readingModal.style.display = 'none';
                });
                
                // è®¾ç½®èŠå¤©è¾“å…¥å’Œå‘é€åŠŸèƒ½
                const chatInput = document.getElementById('chatInput');
                const sendMessage = document.getElementById('sendMessage');
                const chatMessages = document.getElementById('chatMessages');
                
                // æ¸…ç©ºç°æœ‰çš„èŠå¤©æ¶ˆæ¯
                chatMessages.innerHTML = '';
                
                // æ”¶é›†å¡”ç½—è§£è¯»æ‰€éœ€çš„æ•°æ®
                const readingData = {
                    question: question ? decodeURIComponent(question) : "å¡”ç½—æŒ‡å¼•",
                    spreadType: spreadType,
                    spreadName: currentSpreadConfig.title,
                    cards: selectedCards.map((card, index) => {
                        return {
                            name: card.displayName, // ä½¿ç”¨å¸¦æœ‰å¯èƒ½çš„"-é€†ä½"åç¼€çš„æ˜¾ç¤ºåç§°
                            position: currentSpreadConfig.labels[index] || `ä½ç½®${index+1}`,
                            index: index
                        };
                    }),
                    date: now.toLocaleDateString('zh-CN', dateOptions)
                };
                
                // è°ƒç”¨AIè¿›è¡Œåˆå§‹è§£è¯»
                getTarotReading(readingData, "åˆå§‹è§£è¯»").then(response => {
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    const welcomeHtml = `
                        <div class="message">
                            <div class="message-tarot">
                                ${response.welcome || `âœ¨ æ¬¢è¿è¿›å…¥å¡”ç½—è§£è¯»`}
                            </div>
                            <div class="message-info message-tarot-info">
                                å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                            </div>
                        </div>
                    `;
                    chatMessages.insertAdjacentHTML('beforeend', welcomeHtml);
                    
                    // æ·»åŠ çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»
                    setTimeout(() => {
                        if (response.firstCard) {
                            const firstCardHtml = `
                                <div class="message">
                                    <div class="message-tarot">
                                        ${response.firstCard}
                                    </div>
                                    <div class="message-info message-tarot-info">
                                        å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                                    </div>
                                </div>
                            `;
                            chatMessages.insertAdjacentHTML('beforeend', firstCardHtml);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                        
                        // å¦‚æœæœ‰é¢å¤–çš„æ¶ˆæ¯ï¼Œä¾æ¬¡æ˜¾ç¤º
                        if (response.additionalMessages && response.additionalMessages.length > 0) {
                            let delay = 800;
                            response.additionalMessages.forEach((message, index) => {
                                setTimeout(() => {
                                    const messageHtml = `
                                        <div class="message">
                                            <div class="message-tarot">
                                                ${message}
                                            </div>
                                            <div class="message-info message-tarot-info">
                                                å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                                            </div>
                                        </div>
                                    `;
                                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }, delay + index * 800); // æ¯æ¡æ¶ˆæ¯ä¹‹é—´é—´éš”800æ¯«ç§’
                            });
                        }
                    }, 800); // ç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»å»¶è¿Ÿ800æ¯«ç§’æ˜¾ç¤º
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
                
                function sendUserMessage() {
                    const messageText = chatInput.value.trim();
                    if (!messageText) return;
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    const messageHtml = `
                        <div class="message">
                            <div class="message-user">
                                ${messageText}
                            </div>
                            <div class="message-info message-user-info">
                                æ‚¨ â€¢ åˆšåˆš
                            </div>
                        </div>
                    `;
                    
                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                    chatInput.value = '';
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // å…ˆç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„æ€è€ƒæŒ‡ç¤ºå™¨
                    const existingIndicator = document.getElementById('thinking-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                    
                    
                    // è°ƒç”¨AIå›å¤
                    getTarotReading(readingData, messageText).then(response => {
                        
                        // é‡æ–°å¯ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
                        chatInput.disabled = false;
                        sendMessage.disabled = false;
                        chatInput.focus();
                        
                        if (response.welcomeResponse) {
                            // æœ‰åˆ†æ®µå›å¤ï¼Œæ˜¾ç¤ºç¬¬ä¸€æ¡ç®€çŸ­å›å¤
                            const shortResponseHtml = `
                                <div class="message">
                                    <div class="message-tarot">
                                        ${response.welcomeResponse}
                                    </div>
                                    <div class="message-info message-tarot-info">
                                        å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                                    </div>
                                </div>
                            `;
                            chatMessages.insertAdjacentHTML('beforeend', shortResponseHtml);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            
                            // ä¾æ¬¡æ˜¾ç¤ºåç»­å›å¤
                            if (response.additionalResponses && response.additionalResponses.length > 0) {
                                let delay = 800;
                                response.additionalResponses.forEach((message, index) => {
                                    setTimeout(() => {
                                        const messageHtml = `
                                            <div class="message">
                                                <div class="message-tarot">
                                                    ${message}
                                                </div>
                                                <div class="message-info message-tarot-info">
                                                    å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                                                </div>
                                            </div>
                                        `;
                                        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    }, delay + index * 800); // æ¯æ¡æ¶ˆæ¯ä¹‹é—´é—´éš”800æ¯«ç§’
                                });
                            }
                        } else {
                            // æ²¡æœ‰åˆ†æ®µå›å¤ï¼Œæ˜¾ç¤ºå•æ¡å›å¤
                            simulateTarotResponse(response.reply);
                        }
                    }).catch(error => {
                        // ç§»é™¤æ€è€ƒæŒ‡ç¤ºå™¨
                        const thinkingIndicator = document.getElementById('thinking-indicator');
                        if (thinkingIndicator) {
                            thinkingIndicator.remove();
                        }
                        
                        // é‡æ–°å¯ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
                        chatInput.disabled = false;
                        sendMessage.disabled = false;
                        
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                        simulateTarotResponse(`æŠ±æ­‰ï¼Œå¡”ç½—è§£è¯»æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚è¯·ç¨åå†è¯•ã€‚`);
                    });
                }
                
                sendMessage.addEventListener('click', sendUserMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendUserMessage();
                    }
                });
                
                // è®¾ç½®å…¶ä»–æŒ‰é’®äº‹ä»¶
                document.getElementById('saveReading').addEventListener('click', function() {
                    alert('è§£è¯»å·²ä¿å­˜ï¼ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰');
                });
                
                document.getElementById('newReading').addEventListener('click', function() {
                    readingModal.style.display = 'none';
                    redrawButton.click(); // è§¦å‘é‡æ–°æŠ½ç‰Œ
                });
            }
            
            // æ¨¡æ‹Ÿå¡”ç½—å›å¤åŠŸèƒ½
            function simulateTarotResponse(customResponse = null) {
                const responses = [
                    "å¡”ç½—ç‰Œä¸ºæ‚¨æŒ‡å¼•çš„æ˜¯ï¼Œæ­¤åˆ»æ‚¨åº”è¯¥æ›´åŠ ä¿¡ä»»è‡ªå·±çš„ç›´è§‰ã€‚æ‚¨æ‰€é€‰çš„å¡ç‰Œå±•ç¤ºäº†ä¸€ä¸ªå¼ºå¤§çš„å†…åœ¨æ™ºæ…§ï¼Œç­‰å¾…è¢«é‡Šæ”¾ã€‚",
                    "æˆ‘çœ‹åˆ°æ‚¨é¢ä¸´çš„éšœç¢å¯èƒ½ä¸è¿‡å»çš„ç»å†æœ‰å…³ã€‚è¿™äº›ã€Œéšœç¢ã€ç‰Œä½ä¸Šçš„èƒ½é‡æç¤ºæ‚¨éœ€è¦æ”¾ä¸‹è¿‡å»ï¼Œæ‰èƒ½è¿æ¥æ–°çš„æœºä¼šã€‚",
                    "è¿™ä¸ªç»„åˆå¾ˆæœ‰æ„æ€ï¼Œå„å¼ å¡ç‰Œå…±åŒæŒ‡å‘ä¸€ä¸ªè½¬å˜æœŸã€‚æ‚¨ä¼¼ä¹æ­£å¤„äºä¸€ä¸ªå†³ç­–ç‚¹ä¸Šï¼Œä»»ä½•é€‰æ‹©éƒ½å°†å¸¦æ¥æ·±è¿œçš„å½±å“ã€‚",
                    "æ ¹æ®æ‚¨æŠ½åˆ°çš„å¡ç‰Œï¼Œç‰¹åˆ«æ˜¯åœ¨ã€Œå»ºè®®ã€ä½ç½®ä¸Šçš„ç‰Œï¼Œç°åœ¨æ˜¯é‡‡å–è¡ŒåŠ¨çš„æ—¶å€™äº†ã€‚ä¸è¦å†ç­‰å¾…å®Œç¾æ—¶æœºï¼Œå› ä¸ºæœºä¼šå°±åœ¨å½“ä¸‹ã€‚",
                    "è®©æˆ‘ä»¬æ›´æ·±å…¥æ¢è®¨æ‚¨æŠ½åˆ°çš„å¡ç‰Œç»„åˆã€‚å®ƒä»¬å±•ç¤ºäº†ä¸€ä¸ªæ¸…æ™°çš„èƒ½é‡æµåŠ¨ï¼Œä»å½“å‰çŠ¶æ€ä¸€ç›´åˆ°æœªæ¥çš„å¯èƒ½æ€§ã€‚æ‚¨å‡†å¤‡å¥½è¿æ¥è¿™ä¸ªæ—…ç¨‹äº†å—ï¼Ÿ"
                ];
                
                const responseText = customResponse || responses[Math.floor(Math.random() * responses.length)];
                
                const responseHtml = `
                    <div class="message">
                        <div class="message-tarot">
                            ${responseText}
                        </div>
                        <div class="message-info message-tarot-info">
                            å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                        </div>
                    </div>
                `;
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.insertAdjacentHTML('beforeend', responseHtml);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // é¢„è®¾AI APIæ¥å£ï¼Œè·å–å¡”ç½—ç‰Œè§£è¯»
            async function getTarotReading(readingData, userMessage) {
                // å¦‚æœå¯ç”¨äº†APIå¹¶ä¸”æœ‰APIå¯†é’¥
                if (apiSettings.apiKey) {
                    try {
                        // æ„å»ºå¡”ç½—ç‰Œæç¤ºè¯
                        const fullPrompt = `${baseTarotPrompt}
                        
ç”¨æˆ·é—®é¢˜: ${readingData.question}
ç‰Œé˜µç±»å‹: ${readingData.spreadName}
æŠ½å–çš„å¡”ç½—ç‰Œ:
${readingData.cards.map(card => `${card.position}: ${card.name}`).join('\n')}

${userMessage === "åˆå§‹è§£è¯»" ? 
"è¯·æä¾›åˆå§‹è§£è¯»ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯åº”æ˜¯ç®€çŸ­çš„é—®å€™ï¼ˆä¸è¶…è¿‡20å­—ï¼‰ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯æ‰è¯¦ç»†è§£è¯»ç¬¬ä¸€å¼ ç‰Œï¼ŒæŠŠå†…å®¹åˆ†æˆå¤šæ¡ç‹¬ç«‹æ¶ˆæ¯\næ³¨æ„ï¼š\n1. ä¸è¦ä½¿ç”¨---ä½œä¸ºåˆ†éš”ç¬¦\n2. ä¸è¦ä½¿ç”¨###ä½œä¸ºæ ‡é¢˜æ ‡è®°ï¼Œç”¨emojiä»£æ›¿\n3. æ¯æ¡æ¶ˆæ¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”" : 
`ç”¨æˆ·æ¶ˆæ¯: ${userMessage}\nè¯·æ ¹æ®ç”¨æˆ·æ¶ˆæ¯æä¾›å›åº”ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯åº”æ˜¯ç®€çŸ­çš„å›åº”ï¼ˆä¸è¶…è¿‡20å­—ï¼‰ï¼Œåç»­æ¶ˆæ¯å†è¯¦ç»†åˆ†æ\næ³¨æ„ï¼š\n1. ä¸è¦ä½¿ç”¨---ä½œä¸ºåˆ†éš”ç¬¦\n2. ä¸è¦ä½¿ç”¨###ä½œä¸ºæ ‡é¢˜æ ‡è®°ï¼Œç”¨emojiä»£æ›¿\n3. æ¯æ¡æ¶ˆæ¯ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”`}`;

                        // ç¡®å®šä½¿ç”¨çš„æ¨¡å‹
                        const modelToUse = apiSettings.model === 'custom' ? apiSettings.customModel : apiSettings.model;
                        
                        try {
                            // å‘é€è¯·æ±‚åˆ°API
                            const response = await fetch(apiSettings.apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiSettings.apiKey}`
                                },
                                body: JSON.stringify({
                                    model: modelToUse,
                                    messages: [
                                        {role: "system", content: fullPrompt},
                                        {role: "user", content: userMessage === "åˆå§‹è§£è¯»" ? 
                                            "è¯·æä¾›è§£è¯»ï¼Œå…ˆç®€çŸ­é—®å€™ï¼Œç„¶ååˆ†åˆ«è§£è¯»å„å¼ ç‰Œï¼Œæ¯æ®µå†…å®¹ä½œä¸ºç‹¬ç«‹æ¶ˆæ¯å‘é€ã€‚è®°ä½ä¸è¦ä½¿ç”¨åˆ†éš”ç¬¦ï¼Œä¹Ÿä¸è¦ä½¿ç”¨###æ ‡é¢˜æ ‡è®°ï¼Œç”¨emojiä»£æ›¿ã€‚å¦‚æœéœ€è¦è¯´å¾ˆå¤šè¯æ—¶ï¼Œè¯·æŠŠè¯è®²å®Œï¼Œä¸è¦ä¸­æ–­ã€‚" : 
                                            userMessage}
                                    ],
                                    temperature: parseFloat(apiSettings.temperature)
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok && data.choices && data.choices.length > 0) {
                                const aiResponse = data.choices[0].message.content;
                                
                                // å¤„ç†è¿”å›çš„æ¶ˆæ¯ï¼Œä½¿ç”¨åŒæ¢è¡Œç¬¦ä½œä¸ºæ¶ˆæ¯åˆ†éš”
                                const processMessageContent = (content) => {
                                    // ç§»é™¤ä»»ä½•---åˆ†éš”ç¬¦
                                    const withoutSeparators = content.replace(/---+/g, '');
                                    
                                    // æ›¿æ¢###æ ‡é¢˜æ ¼å¼ä¸ºé€‚å½“çš„emoji (å¦‚æœå­˜åœ¨)
                                    const withEmojiTitles = withoutSeparators.replace(/###\s*(.*?)(?:\n|$)/g, (match, title) => {
                                        // æ ¹æ®æ ‡é¢˜å†…å®¹é€‰æ‹©åˆé€‚çš„emoji
                                        let emoji = 'âœ¨';
                                        if (title.includes('è¿‡å»') || title.includes('å†å²')) emoji = 'â®ï¸';
                                        else if (title.includes('ç°åœ¨') || title.includes('å½“å‰')) emoji = 'âºï¸';
                                        else if (title.includes('æœªæ¥')) emoji = 'â­ï¸';
                                        else if (title.includes('å»ºè®®') || title.includes('æŒ‡å¼•')) emoji = 'ğŸ”®';
                                        else if (title.includes('æ ¸å¿ƒ') || title.includes('ä¸­å¿ƒ')) emoji = 'ğŸ¯';
                                        else if (title.includes('éšœç¢') || title.includes('æŒ‘æˆ˜')) emoji = 'ğŸ§©';
                                        else if (title.includes('ç»“æœ') || title.includes('ç»“è®º')) emoji = 'ğŸ';
                                        else if (title.includes('æ€»ç»“')) emoji = 'ğŸ“';
                                        return `${emoji} ${title}\n`;
                                    });
                                    
                                    // ä½¿ç”¨åŒæ¢è¡Œç¬¦åˆ†å‰²æ¶ˆæ¯
                                    return withEmojiTitles.split(/\n\s*\n/).filter(msg => msg.trim().length > 0);
                                };
                                
                                if (userMessage === "åˆå§‹è§£è¯»") {
                                    // å¤„ç†åˆå§‹è§£è¯»æ¶ˆæ¯
                                    const messages = processMessageContent(aiResponse);
                                    
                                    // ç¡®ä¿è‡³å°‘æœ‰ä¸€æ¡æ¶ˆæ¯
                                    if (messages.length === 0) {
                                        messages.push("âœ¨ æ¬¢è¿è¿›å…¥å¡”ç½—è§£è¯»");
                                    }
                                    
                                    // è¿”å›åˆ†å‰²åçš„æ¶ˆæ¯
                                    return {
                                        welcome: messages[0], // ç¬¬ä¸€æ¡ç®€çŸ­çš„é—®å€™
                                        firstCard: messages.length > 1 ? messages[1] : '', // ç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»
                                        additionalMessages: messages.slice(2), // é¢å¤–çš„æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                                        reply: "è¯·å‘Šè¯‰æˆ‘æ‚¨å¯¹è¿™ä¸ªè§£è¯»æœ‰ä»€ä¹ˆæ„Ÿå—æˆ–ç–‘é—®ï¼Ÿ" // é»˜è®¤å¼•å¯¼å›å¤
                                    };
                                } else {
                                    // å¤„ç†ç”¨æˆ·é—®é¢˜çš„å›å¤
                                    const messages = processMessageContent(aiResponse);
                                    
                                    // å¦‚æœæ²¡æœ‰æˆåŠŸåˆ†å‰²æ¶ˆæ¯ï¼Œæˆ–è€…åªæœ‰ä¸€æ¡æ¶ˆæ¯
                                    if (messages.length <= 1) {
                                        return {
                                            reply: aiResponse
                                        };
                                    } else {
                                        // è¿”å›åˆ†å‰²åçš„å¤šæ¡æ¶ˆæ¯
                                        return {
                                            welcomeResponse: messages[0], // ç¬¬ä¸€æ¡ç®€çŸ­å›åº”
                                            additionalResponses: messages.slice(1) // åç»­çš„è¯¦ç»†åˆ†æ
                                        };
                                    }
                                }
                            } else {
                                // è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿ
                                return {
                                    welcome: userMessage === "åˆå§‹è§£è¯»" ? "âœ¨ ä¸å¡”ç½—èƒ½é‡å»ºç«‹è¿æ¥ä¸­..." : null,
                                    firstCard: userMessage === "åˆå§‹è§£è¯»" ? "å¾ˆæŠ±æ­‰ï¼Œå¡”ç½—æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚" : null,
                                    reply: `æŠ±æ­‰ï¼Œæ— æ³•è¿æ¥åˆ°å¡”ç½—è§£è¯»æœåŠ¡ã€‚é”™è¯¯: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`
                                };
                            }
                        } catch (error) {
                            // å‘ç”Ÿé”™è¯¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿ
                            return {
                                welcome: userMessage === "åˆå§‹è§£è¯»" ? "âœ¨ æ¬¢è¿æ¥åˆ°å¡”ç½—è§£è¯»" : null,
                                firstCard: userMessage === "åˆå§‹è§£è¯»" ? "å¾ˆæŠ±æ­‰ï¼Œå¡”ç½—æœåŠ¡è¿æ¥å‡ºç°é—®é¢˜ã€‚" : null,
                                reply: `æŠ±æ­‰ï¼Œè¿æ¥å¡”ç½—è§£è¯»æœåŠ¡æ—¶å‡ºé”™: ${error.message || 'æœªçŸ¥é”™è¯¯'}`
                            };
                        }
                    } catch (error) {
                        // å…¶ä»–é”™è¯¯ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
                        return {
                            welcome: userMessage === "åˆå§‹è§£è¯»" ? "âœ¨ æ¬¢è¿æ¥åˆ°å¡”ç½—è§£è¯»" : null,
                            firstCard: userMessage === "åˆå§‹è§£è¯»" ? "å¾ˆæŠ±æ­‰ï¼Œå¤„ç†å¡”ç½—ä¿¡æ¯æ—¶å‡ºç°é—®é¢˜ã€‚" : null,
                            reply: `æŠ±æ­‰ï¼Œå¤„ç†å¡”ç½—æ•°æ®æ—¶å‡ºé”™: ${error.message || 'æœªçŸ¥é”™è¯¯'}`
                        };
                    }
                } else {
                    // å¦‚æœæœªè®¾ç½®APIå¯†é’¥
                    return {
                        welcome: userMessage === "åˆå§‹è§£è¯»" ? "âœ¨ æ¬¢è¿æ¥åˆ°å¡”ç½—è§£è¯»" : null,
                        firstCard: userMessage === "åˆå§‹è§£è¯»" ? "è¯·åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥ä»¥å¯ç”¨å¡”ç½—è§£è¯»åŠŸèƒ½ã€‚" : null,
                        reply: "è¯·é…ç½®APIå¯†é’¥ä»¥ä½¿ç”¨å¡”ç½—è§£è¯»åŠŸèƒ½ã€‚ç‚¹å‡»å³ä¸Šè§’çš„è®¾ç½®å›¾æ ‡è¿›è¡Œé…ç½®ã€‚"
                    };
                }
            }

            // å±•å¼€ä¸ºæ‰‡å½¢
            function expandToFan() {
                const leftDeck = document.getElementById('leftDeck');
                const middleDeck = document.getElementById('middleDeck');
                const rightDeck = document.getElementById('rightDeck');
                const expandDeckBtn = document.getElementById('expandDeckBtn');
                
                // éšè—å±•å¼€æŒ‰é’®
                expandDeckBtn.style.display = 'none';
                
                // å¯åŠ¨æ´—ç‰ŒåŠ¨ç”»åºåˆ— - ç‚¹å‡»å±•å¼€æ—¶ä¸æ˜¾ç¤º"æ­£åœ¨æ´—ç‰Œ"çŠ¶æ€æ 
                showShuffleAnimation();
            }

            // æ´—ç‰ŒåŠ¨ç”»åºåˆ—
            function showShuffleAnimation() {
                // éšè—æ‰‡å½¢åŒºåŸŸï¼Œç›´åˆ°åŠ¨ç”»ç»“æŸ
                const fanContainer = document.querySelector('.tarot-fan');
                if (fanContainer) {
                    fanContainer.style.visibility = 'hidden';
                }
                
                // åˆ›å»ºæ´—ç‰ŒåŠ¨ç”»å®¹å™¨
                const shuffleContainer = document.createElement('div');
                shuffleContainer.className = 'shuffle-container';
                document.querySelector('.tarot-container').appendChild(shuffleContainer);
                
                const isWideAspect = window.innerWidth / window.innerHeight >= 1;
                const cardWidth = isWideAspect ? 178 : 89;
                const cardHeight = isWideAspect ? 300 : 150;
                
                // é˜¶æ®µ1: åˆ›å»ºåˆå§‹ç‰Œå †
                const mainDeck = document.createElement('div');
                mainDeck.className = 'shuffle-deck';
                mainDeck.style.zIndex = '10';
                shuffleContainer.appendChild(mainDeck);
                
                // åˆ›å»ºåˆå§‹æ•£ä¹±å¡ç‰‡
                const numScatteredCards = 35;
                const cards = [];
                
                for (let i = 0; i < numScatteredCards; i++) {
                    const card = document.createElement('div');
                    card.className = 'shuffle-card';
                    card.style.opacity = '0';
                    card.style.zIndex = i;
                    shuffleContainer.appendChild(card);
                    cards.push(card);
                }
                
                // åŠ¨ç”»æ—¶é—´çº¿ - ç¬¬ä¸€é˜¶æ®µï¼šæ‰“ä¹±å±•å¼€ (å»¶é•¿3ç§’)
                setTimeout(() => {
                    // é˜¶æ®µ1: æ‰“ä¹±å±•å¼€ - ä»ä¸»ç‰Œå †æ•£å¼€
                    for (let i = 0; i < cards.length; i++) {
                        setTimeout(() => {
                            const randomX = (Math.random() - 0.5) * window.innerWidth * 0.6;
                            const randomY = (Math.random() - 0.5) * window.innerHeight * 0.6;
                            const randomRotate = (Math.random() - 0.5) * 40;
                            
                            cards[i].style.opacity = '1';
                            cards[i].style.transform = `translate(${randomX}px, ${randomY}px) rotate(${randomRotate}deg)`;
                        }, i * 100);
                    }
                }, 500);
                
                // ç¬¬äºŒé˜¶æ®µï¼šåˆ‡ç‰Œ (å»¶é•¿3ç§’)
                setTimeout(() => {
                    // é˜¶æ®µ2: åˆ‡ç‰Œ - å°†æ•£å¼€çš„ç‰Œæ”¶é›†æˆ3å †
                    const leftPileX = -cardWidth * 1.2;
                    const rightPileX = cardWidth * 1.2;
                    
                    // åˆ›å»ºå·¦ã€ä¸­ã€å³ä¸‰å †
                    const leftPile = document.createElement('div');
                    leftPile.className = 'shuffle-deck';
                    leftPile.style.transform = `translateX(${leftPileX}px)`;
                    shuffleContainer.appendChild(leftPile);
                    
                    const rightPile = document.createElement('div');
                    rightPile.className = 'shuffle-deck';
                    rightPile.style.transform = `translateX(${rightPileX}px)`;
                    shuffleContainer.appendChild(rightPile);
                    
                    // å°†æ•£ä¹±çš„ç‰Œæ”¶å›åˆ°ä¸‰å †
                    for (let i = 0; i < cards.length; i++) {
                        setTimeout(() => {
                            // éšæœºåˆ†é…åˆ°å·¦ã€ä¸­ã€å³ä¸‰å †
                            const pileIndex = i % 3; // 0=å·¦, 1=ä¸­, 2=å³
                            let targetX = 0;
                            
                            if (pileIndex === 0) targetX = leftPileX;
                            else if (pileIndex === 2) targetX = rightPileX;
                            
                            cards[i].style.transform = `translateX(${targetX}px) translateY(0) rotate(0deg)`;
                            cards[i].style.zIndex = 20 + i;
                        }, i * 100);
                    }
                    
                    // éšè—ä¸»ç‰Œå †
                    mainDeck.style.opacity = '0';
                }, 2000 + 3000);
                
                // ç¬¬ä¸‰é˜¶æ®µï¼šåˆå¹¶ (å»¶é•¿3ç§’)
                setTimeout(() => {
                    // é˜¶æ®µ3: åˆå¹¶ - å°†ä¸‰å †ç‰Œåˆå¹¶åœ¨ä¸€èµ·
                    const allDecks = document.querySelectorAll('.shuffle-deck');
                    allDecks.forEach(deck => {
                        deck.style.transform = 'translate(0, 0)';
                        deck.style.opacity = '1';
                        deck.style.zIndex = '30';
                    });
                    
                    // å°†æ•£ä¹±çš„ç‰Œå…¨éƒ¨åˆå¹¶åˆ°ä¸­é—´
                    cards.forEach(card => {
                        card.style.transform = 'translate(0, 0) rotate(0deg)';
                        card.style.zIndex = '20';
                    });
                }, 3500 + 5000);
                
                // åœ¨ç¬¬ä¸‰é˜¶æ®µç»“æŸåç«‹å³æ˜¾ç¤ºå®‡å®™ä¼ è®¯æç¤º
                setTimeout(() => {
                    showCosmicMessageHint();
                }, 3500 + 5000 + 100); // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ä»¥ç¡®ä¿åœ¨ç¬¬ä¸‰é˜¶æ®µç»“æŸåæ˜¾ç¤º
                
                // ç¬¬å››é˜¶æ®µï¼šå¹³é“º (å»¶é•¿3ç§’)
                const totalAnimationTime = 5000 + 9000; // åŸæ—¶é—´ + å„é˜¶æ®µå»¶é•¿ç´¯è®¡9ç§’
                
                setTimeout(() => {
                    // é˜¶æ®µ4: å¹³é“º - ç§»é™¤æ´—ç‰ŒåŠ¨ç”»å…ƒç´ ï¼Œæ˜¾ç¤ºæœ€ç»ˆçš„æ‰‡å½¢å¸ƒå±€
                    shuffleContainer.remove();
                    
                    // æ˜¾ç¤ºæ‰‡å½¢åŒºåŸŸ
                    if (fanContainer) {
                        fanContainer.style.visibility = 'visible';
                    }
                    
                    // ç”Ÿæˆæ‰‡å½¢å¡ç‰Œï¼Œä¸æ˜¾ç¤ºæ´—ç‰Œæç¤º
                    generateFanCards(true, false); // ä¼ å…¥å‚æ•°è¡¨ç¤ºå¸¦æœ‰åŠ¨ç”»æ•ˆæœï¼Œä½†ä¸æ˜¾ç¤ºæ´—ç‰Œæç¤º
                }, totalAnimationTime);
            }
        });
    </script>
</body>
</html>
